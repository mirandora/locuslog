<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="initial-scale=1.0"/>
    <link rel="stylesheet" type="text/css" href="main.css">
	<title>LOCUS LOG</title>
    <script>
		var t_z = [0,0,0,0,0,0,0,0,0,0];
		var count = 0;

		var start_x = 0;
		var start_y = 0;
		var old_x = 0;
		var old_y = 0;
		
		//移動範囲によって可変。
		var walking_scalar=0.8;
		var latest_x = 0;
		var latest_y = 0;
		var walking_flag=0;
		
		var stop_count=0;

		function get_canvas(){
			var canvas1 = document.getElementById('canvas1');
			if (canvas1.getContext) {
				var container = document.getElementById("canvas_wrapper");
				canvas1.width = container.offsetWidth;
				canvas1.height = container.offsetHeight;

				start_x = canvas1.width/2;
				start_y = canvas1.height/2;
				old_x = canvas1.width/2;
				old_y = canvas1.height/2;
			}
		}
/*
		console.log("cos_0:" + walking_scalar *  Math.cos( 0 * Math.PI / 180 ) );
		console.log("cos_90:" + walking_scalar *  Math.cos( 90 * Math.PI / 180 ) );
		console.log("cos_150:" + walking_scalar *  Math.cos( 150 * Math.PI / 180 ) );
		console.log("cos_280:" + walking_scalar *  Math.cos( 280 * Math.PI / 180 ) );
		console.log("sin_0:" + walking_scalar *  Math.sin( 0 * Math.PI / 180 ) );
		console.log("sin_90:" + walking_scalar *  Math.sin( 90 * Math.PI / 180 ) );
		console.log("sin_150:" + walking_scalar *  Math.sin( 150 * Math.PI / 180 ) );
		console.log("sin_280:" + walking_scalar *  Math.sin( 280 * Math.PI / 180 ) );
*/

	  window.addEventListener("devicemotion", function(event1){
		var x = event1.accelerationIncludingGravity.x;
        var y = event1.accelerationIncludingGravity.y;
        var z = event1.accelerationIncludingGravity.z;

        var result1 = document.getElementById("result1");
        result1.innerHTML = 
          "X_rotate："+ Math.round(x * 10) / 10 +"&nbsp;&nbsp;&nbsp;&nbsp;" +
          "Y_rotate："+ Math.round(y * 10) / 10 +"&nbsp;&nbsp;&nbsp;&nbsp;" + 
          "Z_rotate："+ Math.round(z * 10) / 10;
		
		var result3 = document.getElementById("result3");
		
		//手法2：時間変化が大きいときを移動中とみなす。
		t_z[count] = Math.sqrt(x*x+y*y+z*z);
		count ++;
		
		if(count > 9){
			if( (t_z[0] + t_z[1] + t_z[2] + t_z[3] + t_z[4] )/ (t_z[5] + t_z[6] + t_z[7] + t_z[8] + t_z[9] + 0.000001) > 1.05 || 
			(t_z[0] + t_z[1] + t_z[2] + t_z[3] + t_z[4] )/ (t_z[5] + t_z[6] + t_z[7] + t_z[8] + t_z[9] + 0.000001) < 0.95 ){
				result3.innerHTML =  "motion：walking";
				walking_flag = 1;
				
			}else{
				result3.innerHTML =  "motion：stop";
				walking_flag = 0;
				stop_count++;
			}

			count = 0;
		}
		
		
		if(stop_count>20){
			var canvas = document.getElementById('canvas1');
			if(canvas.getContext){
				var context = canvas.getContext('2d');
				context.fillStyle = 'rgba(51,204,255,0.2)';
				context.arc(old_x, old_y, 22, 0, Math.PI*2, false);
				context.fill();
			}
			
			stop_count=0;
		}
		
		
      }, true);
		window.addEventListener('deviceorientation', function(event2) {
/*			var result4 = document.getElementById("result4");
			result4.innerHTML =   "x："+ old_x + "<br>" +  "y："+ old_y;
*/
			var alpha = event2.alpha;
			var beta = event2.beta;
			var gamma = event2.gamma;

			result2.innerHTML = 
			  "degree："+ Math.round(alpha * 10) / 10;
			
			if(walking_flag == 1){
				old_x = old_x + walking_scalar *  Math.cos( (-1) * alpha.toFixed(1) * Math.PI / 180 );
				old_y = old_y + walking_scalar *  Math.sin( (-1) * alpha.toFixed(1) * Math.PI / 180 );
				latest_x = old_x + walking_scalar *  Math.cos( (-1) * alpha.toFixed(1) * Math.PI  / 180 );
				latest_y = old_y + walking_scalar *  Math.sin(  (-1) * alpha.toFixed(1) * Math.PI  / 180 );
				drawLine(old_x, old_y, latest_x , latest_y);
			}
		}, true);

		function drawLine(x1,y1,x2,y2){
			var canvas = document.getElementById('canvas1');
			if(canvas.getContext){
				var context = canvas.getContext('2d');
				context.strokeStyle = 'rgba(200,200,200,0.5)';
				context.lineWidth = 2.0;
				
				context.beginPath();
				context.moveTo(x1,y1);
				context.lineTo(x2,y2);
				context.closePath();
				context.stroke();

			}
		}
		
		function change_range(x){
			if(x==1){
				walking_scalar=0.8;
				var box1=document.getElementById('select_box1');
				box1.style.color = "#ffccaa";
				box1.style.border = "solid 1px #ffccaa";
				box1.style.webkitBoxShadow = "0 0 20px #ffccaa,inset 0 0 20px #ffccaa";

				var box2=document.getElementById('select_box2');
				box2.style.color = "#73bbc3";
				box2.style.border = "solid 1px #73bbc3";
				box2.style.webkitBoxShadow = "0 0 20px #73bbc3,inset 0 0 20px #73bbc3";
				
				var box3=document.getElementById('select_box3');
				box3.style.color = "#73bbc3";
				box3.style.border = "solid 1px #73bbc3";
				box3.style.webkitBoxShadow = "0 0 20px #73bbc3,inset 0 0 20px #73bbc3";
			}
			else if(x==2){
				walking_scalar=0.4;
				var box1=document.getElementById('select_box1');
				box1.style.color = "#73bbc3";
				box1.style.border = "solid 1px #73bbc3";
				box1.style.webkitBoxShadow = "0 0 20px #73bbc3,inset 0 0 20px #73bbc3";

				var box2=document.getElementById('select_box2');
				box2.style.color = "#ffccaa";
				box2.style.border = "solid 1px #ffccaa";
				box2.style.webkitBoxShadow = "0 0 20px #ffccaa,inset 0 0 20px #ffccaa";
				
				var box3=document.getElementById('select_box3');
				box3.style.color = "#73bbc3";
				box3.style.border = "solid 1px #73bbc3";
				box3.style.webkitBoxShadow = "0 0 20px #73bbc3,inset 0 0 20px #73bbc3";
			}
			else{
				walking_scalar=0.20;
				var box1=document.getElementById('select_box1');
				box1.style.color = "#73bbc3";
				box1.style.border = "solid 1px #73bbc3";
				box1.style.webkitBoxShadow = "0 0 20px #73bbc3,inset 0 0 20px #73bbc3";

				var box2=document.getElementById('select_box2');
				box2.style.color = "#73bbc3";
				box2.style.border = "solid 1px #73bbc3";
				box2.style.webkitBoxShadow = "0 0 20px #73bbc3,inset 0 0 20px #73bbc3";
				
				var box3=document.getElementById('select_box3');
				box3.style.color = "#ffccaa";
				box3.style.border = "solid 1px #ffccaa";
				box3.style.webkitBoxShadow = "0 0 20px #ffccaa,inset 0 0 20px #ffccaa";
			}
		}
		function change_en(){
			var val = document.getElementById("modal_text").innerHTML = "<div id=\"modal_en\">Locus Log use only device senseors.This app doesn't use any GPS or Wifi.So, you can save your locus data even if you are in the underground or indoor.And your locus data doesn't send anywhere, only in your device.</div></div>";
		}
		
		function change_jp(){
			var val = document.getElementById("modal_text").innerHTML = "<div id=\"modal_jp\">本アプリはデバイスのセンサーのみを使用しております。GPSやWifiを利用しておりません。そのため、屋内や狭い領域など、どこでもあなたの移動データを取得することができ、かつ、あなたのデータはどこにも送信されずあなたのデバイス内のみに保存されます。</div>";
		}
    </script>
  </head>
  <body onLoad="get_canvas()">
	<div class="wrapper">
		<center><div id="record" class="blinking">Now Recording Your LOCUS</div></center>    
		<a href="./index.html"><div id="reset">reset</div></a>
		<div id="result3" class="parameter_dis">motion:</div>
		<div id="result1" class="parameter_dis"></div>
		<div id="result2" class="parameter_dis"></div>
		<div id="result4" class="parameter_dis"></div>
		<div id="canvas_wrapper"><canvas id="canvas1"></canvas></div>
		<div id="range_box">
			<ul id="range_select">
					<a href="#" onClick="change_range(1)"><li id="select_box1">10m x 10m</li></a>
					<a href="#" onClick="change_range(2)"><li id="select_box2">20m x 20m</li></a>
					<a href="#" onClick="change_range(3)"><li id="select_box3">40m x 40m</li></a>
			</ul>
		</div>
	</div>
	<div id="footer">
		<a href="#open_modal"><div id="information">i</div></a>
		<div id="modal">
			<div id="open_modal">
				<a href="#" class="close_overlay">×</a>
				<span id="modal_window">
					<h2>Locus Log</h2>
					<div id="switch_ln"><center><a href="javascript:void(0)" onclick="change_en()">English</a> / <a href="javascript:void(0)" onclick="change_jp()">Japanese</a></center></div>
					<div id="modal_text">
					<div id="modal_en">Locus Log use only device senseors.This app doesn't use any GPS or Wifi.
					So, you can save your locus data even if you are in the underground or indoor.
					And your locus data doesn't send anywhere, only in your device.
					</div>
					</div>
					<br>
					<p><a href="#">【×】CLOSE</a></p>
				</span>
			</div>
		</div>
	</div>
</body>
</html>